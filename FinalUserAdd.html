<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPC_SIM // KERNEL_OS</title>
    
    <!-- Fonts: Inter (UI) and JetBrains Mono (Code) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Dark Slate Base */
            --bg-app: #020617;
            --bg-panel: #0f172a;
            --bg-surface: #1e293b;
            
            /* Borders & Separators */
            --border-subtle: #334155;
            --border-active: #475569;

            /* Text */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;

            /* Identity Colors */
            --color-root: #f43f5e;   /* Rose */
            --color-user: #f59e0b;   /* Amber */
            --color-guest: #10b981;  /* Emerald */
            --color-kernel: #6366f1; /* Indigo */
            --color-wire: rgba(255, 255, 255, 0.15);
            
            /* Fonts */
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; user-select: none; outline: none; }

        body {
            margin: 0; padding: 20px;
            background-color: var(--bg-app);
            color: var(--text-primary);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex; flex-direction: column; gap: 20px;
            overflow: hidden;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* --- HEADER (Glass Bar) --- */
        header {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 0 24px;
            height: 70px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.5px;
            display: flex; align-items: center; gap: 12px;
        }
        h1 span {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .status-dot {
            width: 8px; height: 8px;
            background: #22c55e;
            border-radius: 50%;
            box-shadow: 0 0 8px #22c55e;
        }

        /* Button Group */
        .btn-group { display: flex; gap: 8px; }

        .icon-btn {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            width: 42px; height: 42px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover {
            background: var(--bg-app);
            color: var(--text-primary);
            border-color: var(--text-secondary);
            transform: translateY(-1px);
        }
        .reset-btn {
            background: rgba(244, 63, 94, 0.1);
            border: 1px solid rgba(244, 63, 94, 0.2);
            color: var(--color-root);
            font-size: 12px;
            font-weight: 700;
            padding: 0 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-code);
        }
        .reset-btn:hover {
            background: var(--color-root);
            color: white;
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.4);
        }

        /* --- BENTO LAYOUT --- */
        .layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 20px;
            height: 100%;
            min-height: 0;
        }

        /* --- KERNEL SPACE (The Stage) --- */
        .kernel-space {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
        }

        #wire-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }

        /* ACL Legend Floating Pill */
        .acl-legend {
            position: absolute; top: 24px; left: 24px;
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(4px);
            border: 1px solid var(--border-subtle);
            padding: 12px 16px;
            border-radius: 12px;
            pointer-events: none;
        }
        .acl-title {
            font-family: var(--font-code);
            font-size: 10px; color: var(--text-secondary);
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 8px; display: block;
        }
        .acl-item {
            display: flex; align-items: center; gap: 8px;
            font-size: 11px; color: var(--text-primary);
            margin-bottom: 4px;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; }

        /* --- KERNEL NODE (The Core) --- */
        .kernel-node {
            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            width: 220px; height: 160px;
            
            /* Glass Effect */
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            backdrop-filter: blur(4px);
            box-shadow: 0 0 40px rgba(99, 102, 241, 0.15);
            
            border-radius: 20px;
            z-index: 5;
            display: flex; flex-direction: column; align-items: center;
            padding: 12px;
            transition: transform 0.05s;
        }

        .kernel-header {
            font-family: var(--font-code);
            font-size: 10px; letter-spacing: 1px;
            color: #a5b4fc;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .buffer-container {
            width: 100%; flex-grow: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            overflow-y: auto;
            display: flex; flex-direction: column; gap: 4px;
            padding: 4px;
        }
        .buffer-container::-webkit-scrollbar { width: 0; }

        /* Buffered Message Pill */
        .msg-item {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-left: 3px solid transparent;
            font-family: var(--font-code);
            font-size: 10px; padding: 6px;
            border-radius: 4px;
            text-align: center;
            animation: slideIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; justify-content: space-between; padding: 6px 10px;
        }
        @keyframes slideIn { from { transform: translateY(10px); opacity:0; } to { transform: translateY(0); opacity:1; } }

        /* --- PROCESS NODES --- */
        .node {
            position: absolute;
            width: 90px; height: 90px;
            background: var(--bg-panel);
            border: 2px solid transparent;
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            transition: transform 0.2s ease;
        }
        .node:hover { transform: scale(1.05); z-index: 10; }
        
        .node span { font-size: 11px; font-weight: 600; color: var(--text-primary); }
        .pid { 
            font-family: var(--font-code);
            background: rgba(0,0,0,0.5); 
            color: var(--text-secondary); 
            padding: 2px 6px; border-radius: 4px;
            font-size: 9px; margin-top: 4px;
        }

        /* Type Styling */
        .node.root { border-color: var(--color-root); box-shadow: 0 0 20px rgba(244, 63, 94, 0.2); }
        .node.user { border-color: var(--color-user); box-shadow: 0 0 20px rgba(245, 158, 11, 0.2); }
        .node.guest { border-color: var(--color-guest); box-shadow: 0 0 20px rgba(16, 185, 129, 0.2); }

        /* --- SIDEBAR (Control Deck) --- */
        .sidebar { 
            display: flex; flex-direction: column; gap: 20px; 
            height: 100%; min-height: 0;
        }

        /* Panel Card */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 700;
            margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .panel-title::before { content:''; width:4px; height:4px; background:var(--color-kernel); display:inline-block; border-radius:50%; }

        /* Controls */
        .control-group { margin-bottom: 16px; }
        label { font-size: 10px; color: var(--text-muted); font-weight: 600; display: block; margin-bottom: 6px; font-family: var(--font-ui); }
        
        select {
            width: 100%;
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            padding: 10px;
            border-radius: 8px;
            font-family: var(--font-code);
            font-size: 11px;
            cursor: pointer;
            transition: border 0.2s;
        }
        select:hover, select:focus { border-color: var(--color-kernel); }

        .spawn-group { display: flex; gap: 8px; }
        .btn-add {
            background: var(--color-kernel);
            color: white; border: none;
            width: 40px; border-radius: 8px;
            font-size: 18px; cursor: pointer;
            transition: background 0.2s;
        }
        .btn-add:hover { background: #4f46e5; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; border: none;
            padding: 12px; border-radius: 8px;
            font-weight: 600; font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            background: var(--bg-surface);
            border: 1px solid var(--border-active);
            color: var(--text-primary);
            padding: 12px; border-radius: 8px;
            font-weight: 600; font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-secondary:hover { background: var(--border-subtle); }

        /* --- TERMINAL --- */
        .terminal {
            background: #000; /* Deep black */
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            flex-grow: 1;
            padding: 16px;
            font-family: var(--font-code);
            font-size: 11px;
            overflow-y: auto;
            min-height: 0;
            scroll-behavior: smooth;
            position: relative;
        }
        .terminal::before {
            content: 'root@kernel:~$ logs --watch';
            display: block; color: var(--text-secondary);
            border-bottom: 1px solid #333;
            padding-bottom: 8px; margin-bottom: 12px;
        }
        
        .log-entry { margin-bottom: 6px; padding-left: 8px; border-left: 2px solid #333; line-height: 1.4; }
        .log-entry span { opacity: 0.6; margin-right: 8px; font-size: 10px; }
        
        .log-sys { border-left-color: var(--color-kernel); color: #a5b4fc; }
        .log-err { border-left-color: var(--color-root); color: #fda4af; }
        .log-success { border-left-color: var(--color-guest); color: #6ee7b7; }

        /* --- ANIMATIONS & PACKETS --- */
        .packet {
            position: absolute; width: 28px; height: 28px;
            background: var(--bg-app);
            border: 1px solid var(--color-kernel);
            border-radius: 6px;
            color: white; display: flex; justify-content: center; align-items: center;
            font-size: 14px; z-index: 20;
            box-shadow: 0 0 15px var(--color-kernel);
        }
        .packet-label {
            position: absolute; top: -24px; left: 50%; transform: translateX(-50%);
            background: var(--color-kernel); color: white;
            font-size: 9px; padding: 2px 6px; border-radius: 4px;
            white-space: nowrap; font-weight: 700; font-family: var(--font-code);
        }

        .overlay-icon {
            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            z-index: 50;
            pointer-events: none;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5));
            animation: popFade 0.8s forwards;
        }
        @keyframes popFade {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -80%) scale(0.8); opacity: 0; }
        }

        hr { border: 0; border-top: 1px solid var(--border-subtle); margin: 20px 0; }
    </style>
</head>
<body>

<header>
    <h1>
        <div class="status-dot"></div>
        <span>IPC_SIM</span> // KERNEL
    </h1>
    <div class="btn-group">
        <button class="icon-btn" onclick="sim.undo()" title="Undo (Ctrl+Z)">âŽŒ</button>
        <button class="icon-btn" onclick="sim.redo()" title="Redo (Ctrl+Y)">â†»</button>
        <button class="reset-btn" onclick="sim.reset()" title="Reset System">REBOOT SYSTEM</button>
    </div>
</header>

<div class="layout">
    <!-- KERNEL SPACE -->
    <div class="kernel-space" id="kernelSpace">
        <canvas id="wire-layer"></canvas>
        
        <!-- ACL Legend -->
        <div class="acl-legend">
            <span class="acl-title">ACCESS CONTROL</span>
            <div class="acl-item"><div class="dot" style="background:var(--color-root)"></div> ROOT (Full)</div>
            <div class="acl-item"><div class="dot" style="background:var(--color-user)"></div> USER (Restricted)</div>
            <div class="acl-item"><div class="dot" style="background:var(--color-guest)"></div> GUEST (Sandbox)</div>
        </div>

        <!-- Kernel Node -->
        <div class="kernel-node" id="kernelNode">
            <div class="kernel-header">KERNEL BUFFER</div>
            <div class="buffer-container" id="bufferContainer">
                <div style="opacity:0.4; font-family:var(--font-code); font-size:10px; text-align:center; margin-top:10px;">[BUFFER EMPTY]</div>
            </div>
        </div>
    </div>

    <!-- CONTROL PANEL -->
    <aside class="sidebar">
        <div class="panel">
            <div class="panel-title">Process Manager</div>
            
            <div class="spawn-group">
                <select id="spawnType">
                    <option value="root">ROOT (Admin)</option>
                    <option value="user">USER (Standard)</option>
                    <option value="guest">GUEST (Restricted)</option>
                </select>
                <button class="btn-add" onclick="sim.spawn()">+</button>
            </div>
            
            <hr>

            <div class="panel-title">Message Routing</div>

            <div class="control-group">
                <label>SENDER (PID)</label>
                <select id="senderSelect"></select>
            </div>
            
            <div style="text-align:center; color:var(--text-secondary); margin-bottom:8px;">â†“</div>

            <div class="control-group">
                <label>RECEIVER (PID)</label>
                <select id="receiverSelect"></select>
            </div>

            <div class="action-grid">
                <button class="btn-primary" onclick="sim.send()">SEND MSG</button>
                <button class="btn-secondary" onclick="sim.read()">READ MSG</button>
            </div>
        </div>

        <div class="terminal" id="terminal">
            <div class="log-entry log-sys"><span>[BOOT]</span> System Kernel Initialized...</div>
        </div>
    </aside>
</div>

<script>
class Sim {
    constructor() {
        this.procs = [];
        this.buffer = [];
        this.pid = 100;

        this.history = [];
        this.future = [];

        this.space = document.getElementById('kernelSpace');
        this.kernel = document.getElementById('kernelNode');
        this.bufUI = document.getElementById('bufferContainer');
        this.canvas = document.getElementById('wire-layer');
        this.ctx = this.canvas.getContext('2d');
        this.term = document.getElementById('terminal');

        window.addEventListener('resize', () => this.resize());

        // Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z') { e.preventDefault(); this.undo(); }
                if (e.key === 'y') { e.preventDefault(); this.redo(); }
            }
        });

        // Initial Permanent Processes (Not tracked in Undo stack to prevent deletion)
        this.spawn('root', 'ROOT_SYS', false);
        this.spawn('user', 'USER_WEB', false);
        this.spawn('guest', 'GUEST_1', false);

        // Base snapshot
        this.saveState();

        this.resize();
        this.loop();
    }

    // --- STATE MGMT ---
    snapshot() {
        return {
            processes: this.procs.map(p => ({
                id: p.id, name: p.name, type: p.type, x: p.x, y: p.y
            })),
            buffer: JSON.parse(JSON.stringify(this.buffer)),
            pid: this.pid,
            logHTML: this.term.innerHTML
        };
    }

    saveState() {
        this.history.push(this.snapshot());
        this.future = [];
        if (this.history.length > 50) this.history.shift();
    }

    restoreState(state) {
        this.pid = state.pid;
        this.buffer = state.buffer;
        this.term.innerHTML = state.logHTML;
        this.term.scrollTop = this.term.scrollHeight;

        // Rebuild Process DOM
        this.procs.forEach(p => { if (p.el) p.el.remove(); });

        this.procs = state.processes.map(pData => {
            const el = document.createElement('div');
            el.className = `node ${pData.type}`;
            el.innerHTML = `<span>${pData.name}</span><div class="pid">${pData.id}</div>`;
            this.space.appendChild(el);
            return {...pData, el};
        });

        this.placeNodes();
        this.renderBuf();
        this.updateUI();
    }

    undo() {
        if (this.history.length <= 1) return;
        const current = this.history.pop();
        this.future.push(current);
        const prev = this.history[this.history.length - 1];
        this.restoreState(prev);
    }

    redo() {
        if (this.future.length === 0) return;
        const next = this.future.pop();
        this.history.push(next);
        this.restoreState(next);
    }

    // --- LOGIC ---
    spawn(type, name, record = true) {
        const t = type || document.getElementById('spawnType').value;
        const n = name || `${t.toUpperCase()}_${this.pid}`;
        const p = { id: this.pid++, name: n, type: t, el: null, x:0, y:0 };

        const el = document.createElement('div');
        el.className = `node ${t}`;
        el.innerHTML = `<span>${n}</span><div class="pid">${p.id}</div>`;
        this.space.appendChild(el);
        p.el = el;

        this.procs.push(p);
        this.placeNodes();
        this.updateUI();
        this.log(`Process Spawned: ${n}`, 'sys');

        if (record) this.saveState();
    }

    placeNodes() {
        const cx = this.space.clientWidth / 2;
        const cy = this.space.clientHeight / 2;
        const r = 240;
        const count = this.procs.length;

        this.procs.forEach((p, i) => {
            const ang = Math.PI + (Math.PI * (i + 1) / (count + 1));
            p.x = cx + Math.cos(ang) * r - 45;
            p.y = cy + Math.sin(ang) * r * 0.6 - 45;
            if (p.el) {
                p.el.style.left = `${p.x}px`;
                p.el.style.top = `${p.y}px`;
            }
        });
    }

    check(s, r) {
        if (s.id === r.id) return "Loopback Error";
        if (s.type === 'root') return true;
        if (s.type === 'guest') return r.type === 'guest' ? true : "Guest Restricted";
        if (s.type === 'user') return r.type === 'root' ? "Root Protected" : true;
        return true;
    }

    send() {
        const sId = parseInt(document.getElementById('senderSelect').value);
        const rId = parseInt(document.getElementById('receiverSelect').value);
        if (!sId || !rId) return;

        const s = this.procs.find(p => p.id === sId);
        const r = this.procs.find(p => p.id === rId);

        if (s.id === r.id) {
            this.triggerError('â›”');
            this.log(`BLOCKED: Self-message denied`, 'err');
            return;
        }

        this.anim(s, 'kernel', `TO: ${r.name}`, () => {
            const perm = this.check(s, r);
            if (perm === true) {
                this.buffer.push({from:sId, to:rId});
                this.renderBuf();
                this.log(`Buffered: ${s.name} âž ${r.name}`, 'success');
                this.saveState();
            } else {
                this.triggerError('â›”');
                this.log(`BLOCKED: ${perm}`, 'err');
            }
        });
    }

    read() {
        const sId = parseInt(document.getElementById('senderSelect').value);
        const rId = parseInt(document.getElementById('receiverSelect').value);
        if (!sId || !rId) return;

        if (sId === rId) {
            this.triggerError('â›”');
            this.log(`ERROR: Cannot read self`, 'err');
            return;
        }

        const r = this.procs.find(p => p.id === rId);
        const idx = this.buffer.findIndex(m => m.to === rId && m.from === sId);

        if (idx === -1) {
            this.triggerError('ðŸ“­');
            this.log(`ERROR: Buffer empty for ${r.name}`, 'err');
            return;
        }

        this.buffer.splice(idx, 1);
        this.renderBuf();
        this.saveState();

        this.anim('kernel', r, 'DATA', () => {
            this.log(`Delivered to ${r.name}`, 'success');
        });
    }

    // --- VISUALS ---
    triggerError(icon) {
        const el = document.createElement('div');
        el.className = 'overlay-icon';
        el.innerHTML = icon;
        this.space.appendChild(el);
        setTimeout(() => el.remove(), 1000);

        // Kernel Shake
        let i = 0;
        const shake = setInterval(() => {
            const offsetX = (i % 2 === 0 ? 4 : -4);
            this.kernel.style.transform = `translate(calc(-50% + ${offsetX}px), -50%)`;
            i++;
            if (i > 6) {
                clearInterval(shake);
                this.kernel.style.transform = `translate(-50%, -50%)`;
            }
        }, 40);
    }

    renderBuf() {
        this.bufUI.innerHTML = '';
        if (this.buffer.length === 0) {
            this.bufUI.innerHTML = '<div style="opacity:0.4; font-family:var(--font-code); font-size:10px; text-align:center; margin-top:10px;">[BUFFER EMPTY]</div>';
            return;
        }
        this.buffer.forEach(m => {
            const s = this.procs.find(p => p.id === m.from);
            const r = this.procs.find(p => p.id === m.to);
            if (s && r) {
                const d = document.createElement('div');
                d.className = 'msg-item';
                d.innerHTML = `<span>${s.name}</span> <span>â†’</span> <span>${r.name}</span>`;
                // Border color based on destination
                const color = r.type === 'root' ? 'var(--color-root)' : r.type === 'user' ? 'var(--color-user)' : 'var(--color-guest)';
                d.style.borderLeftColor = color;
                this.bufUI.appendChild(d);
            }
        });
    }

    anim(from, to, text, cb) {
        const start = this.getPos(from);
        const end = this.getPos(to);

        const p = document.createElement('div');
        p.className = 'packet';
        p.innerHTML = 'âœ‰<div class="packet-label">'+text+'</div>';
        this.space.appendChild(p);

        const dur = 800;
        const t0 = performance.now();

        const step = (now) => {
            const prog = Math.min((now - t0)/dur, 1);
            const ease = prog < .5 ? 2*prog*prog : -1+(4-2*prog)*prog;

            const x = start.x + (end.x - start.x) * ease;
            const y = start.y + (end.y - start.y) * ease;

            p.style.left = (x-14)+'px';
            p.style.top = (y-14)+'px';

            if (prog < 1) requestAnimationFrame(step);
            else {
                p.remove();
                if (cb) cb();
            }
        };
        requestAnimationFrame(step);
    }

    getPos(obj) {
        if (obj === 'kernel') {
            const r = this.kernel.getBoundingClientRect();
            const s = this.space.getBoundingClientRect();
            return { x: r.left - s.left + r.width/2, y: r.top - s.top + r.height/2 };
        }
        return { x: obj.x + 45, y: obj.y + 45 };
    }

    loop() {
        this.ctx.clearRect(0,0, this.canvas.width, this.canvas.height);
        const k = this.getPos('kernel');

        this.procs.forEach(p => {
            const pc = this.getPos(p);
            this.ctx.beginPath();
            this.ctx.moveTo(k.x, k.y);
            this.ctx.lineTo(pc.x, pc.y);
            this.ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            this.ctx.lineWidth = 2;
            this.ctx.stroke();
        });
        requestAnimationFrame(() => this.loop());
    }

    updateUI() {
        const s = document.getElementById('senderSelect');
        const r = document.getElementById('receiverSelect');
        const sV = s.value; const rV = r.value;
        s.innerHTML=''; r.innerHTML='';
        this.procs.forEach(p => {
            const opt = `<option value="${p.id}">${p.name}</option>`;
            s.innerHTML+=opt; r.innerHTML+=opt;
        });
        if (sV) s.value = sV;
        if (rV) r.value = rV;
    }

    log(msg, type) {
        const c = type==='err'?'log-err':type==='success'?'log-success':'log-sys';
        const time = new Date().toLocaleTimeString('en-US', {hour12:false});
        this.term.insertAdjacentHTML('beforeend', `<div class="log-entry ${c}"><span>[${time}]</span> ${msg}</div>`);
        this.term.scrollTop = this.term.scrollHeight;
    }

    resize() {
        this.canvas.width = this.space.clientWidth;
        this.canvas.height = this.space.clientHeight;
        this.placeNodes();
    }

    reset() { location.reload(); }
}

const sim = new Sim();
</script>
</body>
</html>
